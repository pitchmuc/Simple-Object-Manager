"use strict";class Som{constructor(t,e={dv:void 0,deepcopy:!0,stack:!1,context:void 0}){function s(){const t=new WeakSet;return(e,s)=>{if("object"==typeof s&&null!==s){if(t.has(s))return;t.add(s)}return s}}if(this.data={},this.version="1.0.0",this.deepcopy=null==e.deepcopy||e.deepcopy,this.defaultvalue="string"==typeof arguments[1]?arguments[1]:e.dv,e.stack&&(this.stack=[],this.options={context:e.context}),"object"==typeof t&&t instanceof Som==0)if(Array.isArray(t)&&t.length>0){let e=this.data;if("object"==typeof t[0]){let i=this;t.forEach((function(t){if(i.deepcopy)try{e=Object.assign(e,t)}catch(i){console.warn("issue assigning object, trying removing circular references."),e=Object.assign(e,t,s())}else e=Object.assign(e,t)}))}else this.deepcopy?this.data=Object.assign({},t):this.data=t}else try{this.deepcopy&&0!=arguments[2]?this.data=Object.assign({},t):this.data=t}catch(e){console.warn("issue assigning object, trying removing circular references."),this.data=Object.assign({},t,s())}else if("object"==typeof t&&t instanceof Som==1)try{this.deepcopy?this.data=Object.assign({},t.data):this.data=t.data}catch(e){console.warn("issue assigning object, trying removing circular references."),this.data=Object.assign({},t.data,s())}}get(t,e,s){if(void 0===t||""==t){if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let e={method:"get",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"get",value:this.data}):this.options.context),this.stack.push(e)}return this.data}let i=[];Array.isArray(t)?i=t:i.push(t);let o={};for(const t of i)o[t]={pathSplit:"",value:void 0};for(const t of i)if("string"==typeof t){o[t].pathSplit=t.split(".");let s=this.data,i=t.split(".");for(var a=0;a<i.length&&null!=s;a++)s=Array.isArray(s)&&Math.abs(parseInt(i[a]))<=s.length?parseInt(i[a])<0?s[s.length-Math.abs(parseInt(i[a]))]:s[parseInt(i[a])]:Array.isArray(s)&&Math.abs(parseInt(i[a]))>s.length?e||this.defaultvalue||void 0:s[i[a]];(""===s||void 0===s&&""==e)&&(o[t].value=""),o[t].value=s}let n="";for(let t in o)n=n||o[t].value;if(void 0===n&&""==e||""==n){if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let e={method:"get",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"get",value:""}):this.options.context),this.stack.push(e)}return""}{let i=n||e||this.defaultvalue||void 0;if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let e={method:"get",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"get",value:i}):this.options.context),this.stack.push(e)}return i}}assign(t,e,s=void 0,i){if(this.stack&&Array.isArray(this.stack)&&"internal"!=i&&"override"!=i){let s={method:"assign",path:t};s.method,null!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"assign",value:e}):this.options.context),this.stack.push(s)}void 0===e&&(e=s||this.defaultvalue);let o="override"==arguments[3];if(void 0!==t&&""!=t&&"string"==typeof t){for(var a=t.split("."),n=this.data,r=0;r<a.length&&null!=n;r++)if("["!=a[r][0]&&"]"!=a[r][a[r].length-1])if(Object(n).hasOwnProperty(a[r]))r==a.length-1?Array.isArray(n[a[r]])?o?n[a[r]]=e:n[a[r]].push(e):n[a[r]]=e:("string"!=typeof n[a[r]]&&void 0!==n[a[r]]&&"number"!=typeof n[a[r]]||(n[a[r]]={}),n=n[a[r]]);else if(r==a.length-1){if("object"!=typeof n)return;n[a[r]]=e}else"["!=a[r+1][0]&&"]"!=a[r][a[r+1].length-1]?n[a[r]]={}:n[a[r]]=[],n=n[a[r]];else if("["==a[r][0]&&"]"==a[r][a[r].length-1]){let t=a[r].slice(1,a[r].length-1);Array.isArray(n)&&Math.abs(t)<n.length?r==a.length-1?n[t]=e:n=n[t]:Array.isArray(n)&&t>=n.length&&(r==a.length-1?n.push(e):(n.push({}),n=n[n.length-1]))}}else"object"==typeof t&&(this.data=Object.assign(this.data,t));return this.data}merge(t,e){if("object"==typeof t&&void 0===e)e=t,t=void 0;else if("string"==typeof t&&"object"==typeof e);else if("object"==typeof t&&"string"==typeof e){let s=t;t=e,e=s}if(this.stack&&Array.isArray(this.stack)){let s={method:"merge",path:t};null!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"merge",value:e}):this.options.context),this.stack.push(s)}if(console.log(t),console.log(e),void 0===t||""==t)return this.data=Object.assign(this.data,e),this.data;{let o=t.split("."),a=this.data;for(var s=0;s<o.length&&null!=a;s++)console.log(o[s]),a=Array.isArray(a)&&Math.abs(parseInt(o[s]))<=a.length?parseInt(o[s])<0?a[a.length-Math.abs(parseInt(o[s]))]:a[parseInt(o[s])]:Array.isArray(a)&&Math.abs(parseInt(o[s]))>a.length?this.defaultvalue||void 0:a[o[s]];if(void 0!==a||a!=this.defaultvalue){if(Array.isArray(a)&&Array.isArray(e))e.forEach((function(t){a.push(t)}));else if(Array.isArray(a))a.push(e);else{var i=Object.assign(a,e);this.data=this.assign(t,i,void 0,"internal")}return this.data}return this.assign(t,e,void 0,"internal"),this.data}}remove(t,e){if(this.stack&&Array.isArray(this.stack)&&"internal"!=origin){let e={method:"remove",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"remove",value:void 0}):this.options.context),this.stack.push(e)}if(void 0===e&&(e=!1),""==t||void 0===t)this.clear();else for(var s=t.split("."),i=this.data,o=0;o<s.length&&null!=i;o++)if("string"==typeof s[o]&&1==isNaN(s[o])){if(!Object(i).hasOwnProperty(s[o]))return this.data;o==s.length-1?"object"==typeof i[s[o]]||e?delete i[s[o]]:i[s[o]]=void 0:i=i[s[o]]}else if("string"==typeof s[o]&&0==isNaN(s[o])){if(!(Array.isArray(i)&&Math.abs(s[o])<i.length))return this.data;if(o==s.length-1)return i.splice(s[o],1),this.data;i=i[s[o]]}}push(t,e,s=!1){if(this.stack&&Array.isArray(this.stack)&&"internal"!=origin){let s={method:"push",path:t};null!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"push",value:e}):this.options.context),this.stack.push(s)}if(""==t||void 0===t)this.data=[this.data],this.data.push(e);else if(t.length>0){let i=this.get(t);if(void 0===i||s)this.assign(t,[e],void 0,"override");else if(Array.isArray(i))i.push(e);else if(("object"==typeof i||"string"==typeof i)&&0==s){let s=[i,e];this.assign(t,s,void 0,"internal")}}return this.data}mergeDeep(t,e,s,i){if("string"==typeof t?(e=Array.isArray(e)?Array.from(e):Object.assign({},e),void 0===(s=s||this.get(t,void 0,"internal"))&&(this.assign(t,{}),s=this.get(t,void 0,"internal"))):"object"==typeof t&&(s=e||this.data,e=Array.isArray(e)?Array.from(t):Object.assign({},t)),"object"!=typeof e)throw new Error("expect an object as input");let o=s||this.data;if(this.stack&&Array.isArray(this.stack)&&"internal"!=i){let s={method:"mergeDeep",path:t};null!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"mergeDeep",value:e}):this.options.context),this.stack.push(s)}if(Array.isArray(e)){if(Array.isArray(e)&&Array.isArray(o))for(let t in e)"object"!=typeof e[t]?o.push(e[t]):"object"==typeof e[t]&&this.mergeDeep(e[t],o[t],o[t],"internal")}else for(let t in e)if("object"!=typeof e[t])o[t]=e[t];else if("object"==typeof e[t])if("object"!=typeof o[t])o[t]=e[t];else if(!1===Array.isArray(e[t])&&!1===Array.isArray(o[t]))this.mergeDeep(e[t],o[t],o[t],"internal");else if(Array.isArray(e[t])&&Array.isArray(o[t]))for(let s=0;s<Math.max(e[t].length,o[t].length);s++)void 0===e[t][s]||(void 0===o[t][s]?o[t][s]=e[t][s]:"object"!=typeof e[t][s]?-1==o[t].indexOf(e[t][s])&&o[t].push(e[t][s]):this.mergeDeep(e[t][s],o[t][s],o[t][s],"internal"));else Array.isArray(e[t])&&!Array.isArray(o[t])?o[t]=e[t]:!Array.isArray(e[t])&&Array.isArray(o[t])&&o[t].push(e[t])}replace(t,e,s=!1,i,o){if(this.stack&&Array.isArray(this.stack)&&"internal"!=o){let s={method:"replace"};null!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"replace",value:t,new_value:e}):this.options.context),this.stack.push(s)}let a,n=i||this.data;if(s&&(a=new RegExp(t)),"object"==typeof n)for(let i in n)if("object"!=typeof n[i])s?a.test(n[i])&&(n[i]=e):n[i]==t&&(n[i]=e);else if("object"==typeof n[i])if(Array.isArray(n[i])){let o=this,r=!1;n[i].length>0&&(r="string"==typeof n[i][0]||"number"==typeof n[i][0]);let h=n[i].indexOf(t);if(-1!=h&&(n[i][h]=e),s&&r)for(h=0;h<n[i].length;h++)a.test(n[i][h])&&(n[i][h]=e);else n[i].forEach((function(i){"object"==typeof i&&o.replace(t,e,s,i,"internal")}))}else{if(null==n[i]||void 0===n[i]||n[i]instanceof Som)return;this.replace(t,e,s,n[i],"internal")}}searchValue(t,e=!1,s,i=void 0,o=void 0,a){let n,r=s||this.data,h=null==o?"":o,l=null==i?[]:i;if(e&&(n=new RegExp(t)),"object"==typeof r)for(let s in r)if("object"!=typeof r[s]){if(e){if(n.test(r[s])){let t=""==h?s:h+"."+s;l.push(t)}}else if(r[s]==t){let t=""==h?s:h+"."+s;l.push(t)}}else if(Array.isArray(r[s])){let i=!1;if(r[s].length>0&&(i="string"==typeof r[s][0]||"number"==typeof r[s][0]),i){for(let i=0;i<r[s].length;i++)if(e){if(n.test(r[s][i])){let t=""==h?s:h+"."+s+"."+i;l.push(t)}}else if(r[s][i]==t){let t=""==h?s:h+"."+s+"."+i;l.push(t)}}else for(let i=0;i<r[s].length;i++)if("object"==typeof r[s][i]){let o=""==h?s+"."+i:h+"."+s+"."+i;this.searchValue(t,e,r[s][i],l,o,"internal")}}else if("object"==typeof r[s]){let i=""==h?s:h+"."+s;this.searchValue(t,e,r[s],l,i,"internal")}let c={};if(c[t]=l,this.stack&&Array.isArray(this.stack)&&"internal"!=a){let t={method:"searchValue",path:void 0,value:""};null!=this.options.context&&(t.context="function"==typeof this.options.context?this.options.context({method:"searchValue",value:c}):this.options.context),this.stack.push(t)}return c}subSom(t,e,s,i,o){e=e||!1;let a=this.get(t,this.defaultvalue,"internal");if(a==this.defaultvalue&&0==e?(a={},Array.isArray(t)?this.assign(t[0],a):this.assign(t,a)):a==this.defaultvalue&&1==e&&(a={}),"object"==typeof a){const n=new this.constructor(a,{dv:this.defaultvalue,deepcopy:e,stack:s,context:i});if(this.stack&&Array.isArray(this.stack)&&"internal"!=o){let e={method:"subSom",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"subSom",value:n}):this.options.context),this.stack.push(e)}return n}if(this.stack&&Array.isArray(this.stack)&&"internal"!=o){let e={method:"subSom",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"subSom",value:void 0}):this.options.context),this.stack.push(e)}}getSubNodes(t,e){e=e||!1;const s=this.subSom(t,e,!1,void 0,"internal");let i=Object.fromEntries(Object.keys(s.data).map((t=>[t,s.subSom(t,e,!1,void 0,"internal")])));if(this.stack&&Array.isArray(this.stack)){let e={method:"getSubNodes",path:t};null!=this.options.context&&(e.context="function"==typeof this.options.context?this.options.context({method:"getSubNodes",value:i}):this.options.context),this.stack.push(e)}return i}modify(t,e){if(this.assign(Array.isArray(t)?t[0]:t,e(this.get(t,void 0,"modify"))),this.stack&&Array.isArray(this.stack)){let s={method:"modify",path:t};null!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"modify",value:e(this.get(t,void 0,"modify"))}):this.options.context),this.stack.push(s)}}clear(){if(this.stack&&Array.isArray(this.stack)){let t={method:"clear",path:void 0};null!=this.options.context&&(t.context="function"==typeof this.options.context?this.options.context({method:"clear",value:void 0}):this.options.context),this.stack.push(t)}this.data={}}}module.exports=Som;