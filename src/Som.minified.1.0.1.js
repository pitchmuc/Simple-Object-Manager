"use strict";class Som{constructor(t,e={dv:void 0,deepcopy:!0,stack:!1,context:void 0}){function i(){let t=new WeakSet;return(e,i)=>{if("object"==typeof i&&null!==i){if(t.has(i))return;t.add(i)}return i}}if(this.data={},this.version="1.0.1",this.deepcopy=void 0==e.deepcopy||e.deepcopy,this.defaultvalue="string"==typeof arguments[1]?arguments[1]:e.dv,e.stack&&(this.stack=[],this.options={context:e.context}),"object"==typeof t&&t instanceof Som==!1){if(Array.isArray(t)&&t.length>0){let s=this.data;if("object"==typeof t[0]){let o=this;t.forEach(function(t){if(o.deepcopy)try{s=Object.assign(s,t)}catch(e){console.warn("issue assigning object, trying removing circular references."),s=Object.assign(s,t,i())}else s=Object.assign(s,t)})}else this.deepcopy?this.data=Object.assign({},t):this.data=t}else try{this.deepcopy&&!1!=arguments[2]?this.data=Object.assign({},t):this.data=t}catch(n){console.warn("issue assigning object, trying removing circular references."),this.data=Object.assign({},t,i())}}else if("object"==typeof t&&t instanceof Som==!0)try{this.deepcopy?this.data=Object.assign({},t.data):this.data=t.data}catch(a){console.warn("issue assigning object, trying removing circular references."),this.data=Object.assign({},t.data,i())}}get(t,e,i={origin:void 0,arraycheck:!1}){let s=i.origin,o=i.arraycheck;if(void 0===t||""==t){if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let n={method:"get",path:t};void 0!=this.options.context&&(n.context="function"==typeof this.options.context?this.options.context({method:"get",value:this.data}):this.options.context),this.stack.push(n)}return this.data}let a=[];Array.isArray(t)?a=t:a.push(t);let h={};for(let r of a)h[r]={pathSplit:"",value:void 0};for(let c of a)if("string"==typeof c){h[c].pathSplit=c.split(".");let l=this.data,f=c.split(".");for(var p=0;p<f.length&&void 0!=l;p++)if(l instanceof Set){let d=l;!1==(l=!!l.has(f[p]))&&parseInt(f[p])&&(l=!!d.has(parseInt(f[p])))}else if(Array.isArray(l[f[p]])&&p==f.length-2&&o){let u=l[f[p]];!1==(l=!!l[f[p]].includes(f[p+1]))&&parseInt(f[p+1])&&(l=!!u.includes(parseInt(f[p+1])));break}else l=Array.isArray(l)&&Math.abs(parseInt(f[p]))<=l.length?0>parseInt(f[p])?l[l.length-Math.abs(parseInt(f[p]))]:l[parseInt(f[p])]:Array.isArray(l)&&Math.abs(parseInt(f[p]))>l.length?e||this.defaultvalue||void 0:l[f[p]];(""===l||void 0===l&&""==e)&&(h[c].value=""),h[c].value=l}let y="";for(let g in h)y=y||h[g].value;if(void 0===y&&""==e||""===y||!1===y){if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let v={method:"get",path:t};void 0!=this.options.context&&(v.context="function"==typeof this.options.context?this.options.context({method:"get",value:""}):this.options.context),this.stack.push(v)}return!1===y?y:""}{let $=y||e||this.defaultvalue||void 0;if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let x={method:"get",path:t};void 0!=this.options.context&&(x.context="function"==typeof this.options.context?this.options.context({method:"get",value:$}):this.options.context),this.stack.push(x)}return $}}assign(t,e,i,s={origin:void 0,type:Object,override:void 0}){let o="object"==typeof s?s.origin:s,n="object"==typeof s?s.override:"override"==s,a="object"==typeof s?s.type:Object;if(this.stack&&Array.isArray(this.stack)&&"internal"!=o&&"override"!=o){let h={method:"assign",path:t};h.method,void 0!=this.options.context&&(h.context="function"==typeof this.options.context?this.options.context({method:"assign",value:e}):this.options.context),this.stack.push(h)}if(void 0===e&&(e=i||this.defaultvalue),void 0!==t&&""!=t&&"string"==typeof t){for(var r=t.split("."),c=this.data,l=0;l<r.length&&void 0!=c;l++)if("["!=r[l][0]&&"]"!=r[l][r[l].length-1]){if(Object(c).hasOwnProperty(r[l])){if(l==r.length-1){if(c[r[l]]instanceof Set||a==Set){if(n)a==Set?c[r[l]]=new Set([e]):a==Array?(c[r[l]]=[],c[r[l]].push(e)):c[r[l]]=e;else if(c[r[l]]instanceof Set&&a==Array){let f=Array.from(c[r[l]]);f.push(e),c[r[l]]=f}else if(c[r[l]]instanceof Set)c[r[l]].add(e);else if(c[r[l]]instanceof Array){let p=new Set(c[r[l]]);p.add(e),c[r[l]]=p}else if(c[r[l]]instanceof Object)mySet=new Set([e]),c[r[l]]=mySet;else{let d=new Set([c[r[l]]]);d.add(e),c[r[l]]=d}}else if(Array.isArray(c[r[l]])||a==Array){if(n)a==Set?c[r[l]]=new Set([e]):a==Array?(c[r[l]]=[],c[r[l]].push(e)):c[r[l]]=e;else if(c[r[l]]instanceof Array&&a==Set){let u=new Set(c[r[l]]);u.add(e),c[r[l]]=u}else if(c[r[l]]instanceof Set){let y=Array.from(c[r[l]]);y.push(e),c[r[l]]=y}else if(c[r[l]]instanceof Array)c[r[l]].push(e);else if(c[r[l]]instanceof Object)c[r[l]]=e;else{let g=[c[r[l]]];g.push(e),c[r[l]]=g}}else c[r[l]]=e}else("string"==typeof c[r[l]]||void 0===c[r[l]]||"number"==typeof c[r[l]])&&(c[r[l]]={}),c=c[r[l]]}else if(l==r.length-1){if("object"!=typeof c)return;a==Set?c[r[l]]=new Set([e]):a==Array?c[r[l]]=Array(e):c[r[l]]=e}else"["!=r[l+1][0]&&"]"!=r[l][r[l+1].length-1]?c[r[l]]={}:c[r[l]]=[],c=c[r[l]]}else if("["==r[l][0]&&"]"==r[l][r[l].length-1]){let v=r[l].slice(1,r[l].length-1);Array.isArray(c)&&Math.abs(v)<c.length?l==r.length-1?c[v]=e:c=c[v]:Array.isArray(c)&&v>=c.length&&(l==r.length-1?c.push(e):(c.push({}),c=c[c.length-1]))}}else"object"==typeof t&&(this.data=Object.assign(this.data,t));return this.data}merge(t,e){if("object"==typeof t&&void 0===e)e=t,t=void 0;else if("string"==typeof t&&"object"==typeof e);else if("object"==typeof t&&"string"==typeof e){let i=t;t=e,e=i}if(this.stack&&Array.isArray(this.stack)){let s={method:"merge",path:t};void 0!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"merge",value:e}):this.options.context),this.stack.push(s)}if(void 0===t||""==t)return this.data=Object.assign(this.data,e),this.data;{let o=t.split("."),n=this.data;for(var a=0;a<o.length&&void 0!=n;a++)n=Array.isArray(n)&&Math.abs(parseInt(o[a]))<=n.length?0>parseInt(o[a])?n[n.length-Math.abs(parseInt(o[a]))]:n[parseInt(o[a])]:Array.isArray(n)&&Math.abs(parseInt(o[a]))>n.length?this.defaultvalue||void 0:n[o[a]];if(void 0===n&&n==this.defaultvalue)return this.assign(t,e,void 0,{origin:"internal"}),this.data;if(n instanceof Set&&(e instanceof Array||e instanceof Set))e.forEach(function(t){n.add(t)});else if(Array.isArray(n)&&Array.isArray(e))e.forEach(function(t){n.push(t)});else if(Array.isArray(n))n.push(e);else{var h=Object.assign(n,e);this.data=this.assign(t,h,void 0,{origin:"internal"})}return this.data}}remove(t,e){if(this.stack&&Array.isArray(this.stack)&&"internal"!=origin){let i={method:"remove",path:t};void 0!=this.options.context&&(i.context="function"==typeof this.options.context?this.options.context({method:"remove",value:void 0}):this.options.context),this.stack.push(i)}if(void 0===e&&(e=!1),""==t||void 0===t)this.clear();else for(var s=t.split("."),o=this.data,n=0;n<s.length&&void 0!=o;n++)if("string"==typeof s[n]&&!0==isNaN(s[n])){if(!Object(o).hasOwnProperty(s[n]))return this.data;if(n==s.length-2){if(o[s[n]]instanceof Set)o[s[n]].delete(s[n+1]);else if(o[s[n]]instanceof Array){let a=o[s[n]].indexOf(s[n+1]);-1!=a&&o[s[n]].splice(a,1)}}n==s.length-1?"object"==typeof o[s[n]]?delete o[s[n]]:e?delete o[s[n]]:o[s[n]]=void 0:o=o[s[n]]}else if("string"==typeof s[n]&&!1==isNaN(s[n])){if(!(Array.isArray(o)&&Math.abs(s[n])<o.length))return this.data;if(n==s.length-1)return o.splice(s[n],1),this.data;o=o[s[n]]}}push(t,e,i=!1){if(this.stack&&Array.isArray(this.stack)&&"internal"!=origin){let s={method:"push",path:t};void 0!=this.options.context&&(s.context="function"==typeof this.options.context?this.options.context({method:"push",value:e}):this.options.context),this.stack.push(s)}if(""==t||void 0===t)this.data=[this.data],this.data.push(e);else if(t.length>0){let o=this.get(t);void 0===o||i?this.assign(t,[e],void 0,{override:!0}):o instanceof Set?o.add(e):Array.isArray(o)?o.push(e):("object"==typeof o||"string"==typeof o)&&!1==i&&this.assign(t,[o,e],void 0,{origin:"internal"})}return this.data}mergeDeep(t,e,i,s){if("string"==typeof t?(e=Array.isArray(e)?Array.from(e):Object.assign({},e),void 0===(i=i||this.get(t,void 0,{origin:"internal"}))&&(this.assign(t,{}),i=this.get(t,void 0,{origin:"internal"}))):"object"==typeof t&&(i=e||this.data,e=Array.isArray(e)?Array.from(t):Object.assign({},t)),"object"!=typeof e)throw Error("expect an object as input");let o=i||this.data;if(this.stack&&Array.isArray(this.stack)&&"internal"!=s){let n={method:"mergeDeep",path:t};void 0!=this.options.context&&(n.context="function"==typeof this.options.context?this.options.context({method:"mergeDeep",value:e}):this.options.context),this.stack.push(n)}if(Array.isArray(e)){if(Array.isArray(e)&&Array.isArray(o))for(let a in e)"object"!=typeof e[a]?o.push(e[a]):"object"==typeof e[a]&&this.mergeDeep(e[a],o[a],o[a],"internal")}else for(let h in e)if("object"!=typeof e[h])o[h]=e[h];else if("object"==typeof e[h]){if("object"!=typeof o[h])o[h]=e[h];else if(!1===Array.isArray(e[h])&&!1===Array.isArray(o[h]))this.mergeDeep(e[h],o[h],o[h],"internal");else if(Array.isArray(e[h])&&Array.isArray(o[h]))for(let r=0;r<Math.max(e[h].length,o[h].length);r++)void 0===e[h][r]||(void 0===o[h][r]?o[h][r]=e[h][r]:"object"!=typeof e[h][r]?-1==o[h].indexOf(e[h][r])&&o[h].push(e[h][r]):this.mergeDeep(e[h][r],o[h][r],o[h][r],"internal"));else Array.isArray(e[h])&&!Array.isArray(o[h])?o[h]=e[h]:!Array.isArray(e[h])&&Array.isArray(o[h])&&o[h].push(e[h])}}replace(t,e,i=!1,s,o){if(this.stack&&Array.isArray(this.stack)&&"internal"!=o){let n={method:"replace"};void 0!=this.options.context&&(n.context="function"==typeof this.options.context?this.options.context({method:"replace",value:t,new_value:e}):this.options.context),this.stack.push(n)}let a=s||this.data,h;if(i&&(h=RegExp(t)),"object"==typeof a){for(let r in a)if("object"!=typeof a[r])i?h.test(a[r])&&(a[r]=e):a[r]==t&&(a[r]=e);else if("object"==typeof a[r]){if(Array.isArray(a[r])){let c=this,l=!1;a[r].length>0&&(l="string"==typeof a[r][0]||"number"==typeof a[r][0]);let f=a[r].indexOf(t);if(-1!=f&&(a[r][f]=e),i&&l)for(f=0;f<a[r].length;f++)h.test(a[r][f])&&(a[r][f]=e);else a[r].forEach(function(s){"object"==typeof s&&c.replace(t,e,i,s,"internal")})}else{if(void 0==a[r]||void 0===a[r]||a[r]instanceof Som)break;this.replace(t,e,i,a[r],"internal")}}}}searchValue(t,e=!1,i,s,o,n){let a=i||this.data,h=void 0==o?"":o,r=void 0==s?[]:s,c;if(e&&(c=RegExp(t)),"object"==typeof a){for(let l in a)if("object"!=typeof a[l]){if(e){if(c.test(a[l])){let f=""==h?l:h+"."+l;r.push(f)}}else if(a[l]==t){let p=""==h?l:h+"."+l;r.push(p)}}else if(Array.isArray(a[l])){let d=!1;if(a[l].length>0&&(d="string"==typeof a[l][0]||"number"==typeof a[l][0]),d){for(let u=0;u<a[l].length;u++)if(e){if(c.test(a[l][u])){let y=""==h?l:h+"."+l+"."+u;r.push(y)}}else if(a[l][u]==t){let g=""==h?l:h+"."+l+"."+u;r.push(g)}}else for(let v=0;v<a[l].length;v++)if("object"==typeof a[l][v]){let $=""==h?l+"."+v:h+"."+l+"."+v;this.searchValue(t,e,a[l][v],r,$,"internal")}}else if("object"==typeof a[l]){let x=""==h?l:h+"."+l;this.searchValue(t,e,a[l],r,x,"internal")}}let m={};if(m[t]=r,this.stack&&Array.isArray(this.stack)&&"internal"!=n){let b={method:"searchValue",path:void 0,value:""};void 0!=this.options.context&&(b.context="function"==typeof this.options.context?this.options.context({method:"searchValue",value:m}):this.options.context),this.stack.push(b)}return m}subSom(t,e,i,s,o){e=!!e&&e;let n=this.get(t,this.defaultvalue,{origin:"internal"});if(n==this.defaultvalue&&!1==e?(n={},Array.isArray(t)?this.assign(t[0],n):this.assign(t,n)):n==this.defaultvalue&&!0==e&&(n={}),"object"==typeof n){let a=new this.constructor(n,{dv:this.defaultvalue,deepcopy:e,stack:i,context:s});if(this.stack&&Array.isArray(this.stack)&&"internal"!=o){let h={method:"subSom",path:t};void 0!=this.options.context&&(h.context="function"==typeof this.options.context?this.options.context({method:"subSom",value:a}):this.options.context),this.stack.push(h)}return a}if(this.stack&&Array.isArray(this.stack)&&"internal"!=o){let r={method:"subSom",path:t};void 0!=this.options.context&&(r.context="function"==typeof this.options.context?this.options.context({method:"subSom",value:void 0}):this.options.context),this.stack.push(r)}}getSubNodes(t,e){e=!!e&&e;let i=this.subSom(t,e,!1,void 0,"internal"),s=Object.fromEntries(Object.keys(i.data).map(t=>[t,i.subSom(t,e,!1,void 0,"internal")]));if(this.stack&&Array.isArray(this.stack)){let o={method:"getSubNodes",path:t};void 0!=this.options.context&&(o.context="function"==typeof this.options.context?this.options.context({method:"getSubNodes",value:s}):this.options.context),this.stack.push(o)}return s}modify(t,e){if(this.assign(Array.isArray(t)?t[0]:t,e(this.get(t,void 0,{origin:"modify"}))),this.stack&&Array.isArray(this.stack)){let i={method:"modify",path:t};void 0!=this.options.context&&(i.context="function"==typeof this.options.context?this.options.context({method:"modify",value:e(this.get(t,void 0,{origin:"modify"}))}):this.options.context),this.stack.push(i)}}clear(){if(this.stack&&Array.isArray(this.stack)){let t={method:"clear",path:void 0};void 0!=this.options.context&&(t.context="function"==typeof this.options.context?this.options.context({method:"clear",value:void 0}):this.options.context),this.stack.push(t)}this.data={}}}module.exports=Som;